name: ðŸ” Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      target_sha:
        description: 'SHA to rollback to'
        required: true
        type: string
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - github-pages
          - vercel
          - both

jobs:
  rollback-github-pages:
    name: Rollback GitHub Pages
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'github-pages' || github.event.inputs.environment == 'both'
    permissions:
      contents: read
      pages: write
      id-token: write
    steps:
      - name: Checkout target commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_sha }}

      - name: Download artifacts for target SHA
        uses: actions/github-script@v7
        with:
          script: |
            const { data: artifacts } = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });
            
            const targetArtifact = artifacts.artifacts.find(a => a.name.includes('${{ github.event.inputs.target_sha }}'));
            if (!targetArtifact) {
              core.setFailed('No artifacts found for target SHA');
              return;
            }
            
            const download = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: targetArtifact.id,
              archive_format: 'zip'
            });
            
            const fs = require('fs');
            fs.writeFileSync('dist.zip', Buffer.from(download.data));

      - name: Extract artifacts
        run: unzip dist.zip -d dist

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
        with:
          path: dist/public

  rollback-vercel:
    name: Rollback Vercel
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'vercel' || github.event.inputs.environment == 'both'
    steps:
      - name: Checkout target commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_sha }}

      - name: Install Vercel CLI
        run: npm i -g vercel@latest

      - name: Deploy target commit to Vercel
        run: |
          vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }} --force

  notify-rollback:
    name: Notify Rollback
    needs: [rollback-github-pages, rollback-vercel]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Create rollback summary
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸ”„ Rollback completed!
              - Target SHA: ${{ github.event.inputs.target_sha }}
              - Environment: ${{ github.event.inputs.environment }}
              - Status: ${{ needs.rollback-github-pages.result || needs.rollback-vercel.result }}`
            });